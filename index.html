<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Keran Air 3D — Tekstur • Lighting • Hirarki • Ember</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
  <style>
    html, body { margin:0; height:100%; background:#0d1117; color:#e6edf3; font-family:system-ui, Segoe UI, Roboto, Arial,sans-serif; }
    #app { height:100%; display:grid; grid-template-rows:auto 1fr; }
    header { padding:10px 16px; display:flex; gap:16px; align-items:center; border-bottom:1px solid #24292f; }
    header .note { font-size:12px; opacity:.8; margin-left:auto }
    #canvas-container { position:relative; width:100%; height:calc(100vh - 52px); }
    #gui { position:absolute; top:10px; right:10px; z-index:10; }
    a { color:#58a6ff; text-decoration:none; }
  </style>

  <!-- Import map agar bisa `import "three"` -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>
</head>
<body>
  <div id="app">
    <header>
      <strong>Keran Air 3D</strong>
      <span>Tekstur • Lighting • Hirarki • Ember</span>
      <span class="note">Drag di kanvas / pakai slider untuk ubah debit</span>
    </header>
    <div id="canvas-container"><div id="gui"></div></div>
  </div>

  <!-- Entry module -->
  <script type="module">
    import * as THREE from "three";
    import { OrbitControls } from "three/addons/controls/OrbitControls.js";
    import { RoomEnvironment } from "three/addons/environments/RoomEnvironment.js";

    // Modul lokal
    import { createScene } from "./js/utils.js";
    import { setupLighting } from "./js/lighting.js";
    import { loadTextures, makeTiledWallTexture } from "./js/textures.js";
    import { createFaucet } from "./js/faucet.js";
    import { createBucket } from "./js/bucket.js";
    import { setupHierarchy } from "./js/hierarchy.js";
    import { WaterEmitter } from "./js/water.js";

    // --- Bootstrap ---
    const container = document.getElementById("canvas-container");
    const { renderer, scene, camera } = createScene(container, THREE, OrbitControls);

    // Environment untuk refleksi metal
    const pmrem = new THREE.PMREMGenerator(renderer);
    scene.environment = pmrem.fromScene(new RoomEnvironment(), 0.04).texture;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.15;

    // Lighting
    setupLighting(scene, THREE, renderer);

    // Tekstur preset (sprite air, dll) — opsional
    const tex = await loadTextures(THREE);

    // DINDING ubin
    {
      const wallTex = makeTiledWallTexture(THREE, { rows: 10, cols: 8, grout: "#bfb6ad", tile: "#d9cfc7" });
      const wall = new THREE.Mesh(
        new THREE.PlaneGeometry(6, 3),
        new THREE.MeshStandardMaterial({ map: wallTex, roughness: 0.95, metalness: 0.0 })
      );
      wall.position.set(-0.03, 1.15, 0);  // sangat dekat di belakang flange
      wall.rotation.y = Math.PI / 2;      // menghadap +X
      wall.receiveShadow = true;
      scene.add(wall);
    }

    // Objek: KERAN & EMBER
    const faucet = createFaucet(THREE);   // faucet.js sudah atur koordinat internal (yAxis)
    faucet.root.position.set(0, 0, 0);    // jangan diberi offset lagi
    scene.add(faucet.root);

    const bucket = createBucket(THREE);
    bucket.root.position.set(0.25, 0.22, -0.0); // dasar tepat di lantai
    scene.add(bucket.root);

    // Air (partikel)
    const water = new WaterEmitter(THREE, {
        scene,
        count: 3000,
        originObject: faucet.spoutTip,
        gravity: new THREE.Vector3(0, -9.8, 0),
        bucket: { object: bucket.root, radius: bucket.innerRadius, height: bucket.height }, // ← bisa dihapus jika tanpa ember
        floorY: 0,
        shadow: true
    });

    // Hirarki & interaksi (tuas → debit)
    const api = setupHierarchy(THREE, faucet, water, renderer.domElement, document.getElementById("gui"));

    // Lantai & grid
    {
      const plane = new THREE.Mesh(
        new THREE.PlaneGeometry(6, 6),
        new THREE.MeshStandardMaterial({ color: 0x222428, metalness: 0.0, roughness: 1.0 })
      );
      plane.rotation.x = -Math.PI / 2;
      plane.receiveShadow = true;
      scene.add(plane);

      const grid = new THREE.GridHelper(6, 24, 0x555555, 0x333333);
      grid.position.y = 0.001;
      scene.add(grid);
    }

    // Loop render
    const clock = new THREE.Clock();
    renderer.setAnimationLoop(() => {
      const dt = Math.min(0.033, clock.getDelta());
      water.update(dt);
      api.update(dt);
      renderer.render(scene, camera);
    });

    // Responsif
    window.addEventListener("resize", () => {
      const w = container.clientWidth, h = container.clientHeight;
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
      renderer.setSize(w, h);
    });
  </script>
</body>
</html>
